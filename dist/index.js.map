{"version":3,"sources":["../src/constants.ts","../src/core/utils.ts","../src/core/calendarStrategy.ts","../src/core/wmaStrategy.ts","../src/api/PredictionEngine.ts"],"sourcesContent":["export const DEFAULTS = {\n  lutealPhaseDays: 14,\n  irregularityStdThreshold: 4,\n  minIntervalsForConfidence: 3,\n};\n","import { parseISO, addDays, differenceInCalendarDays, format } from \"date-fns\";\n\nexport function parseIsoDay(s: string): Date {\n  // expect YYYY-MM-DD\n  return parseISO(s);\n}\n\nexport function formatIsoDay(d: Date): string {\n  return format(d, \"yyyy-MM-dd\");\n}\n\nexport function addDaysIso(iso: string, days: number): string {\n  return formatIsoDay(addDays(parseIsoDay(iso), days));\n}\n\nexport function daysBetween(aIso: string, bIso: string): number {\n  return differenceInCalendarDays(parseIsoDay(bIso), parseIsoDay(aIso));\n}\n\nexport function mean(nums: number[]): number {\n  if (nums.length === 0) return 0;\n  return nums.reduce((s, v) => s + v, 0) / nums.length;\n}\n\nexport function std(nums: number[]): number {\n  const m = mean(nums);\n  const variance =\n    nums.reduce((s, v) => s + (v - m) ** 2, 0) / (nums.length || 1);\n  return Math.sqrt(variance);\n}\n\nexport function clamp(v: number, lo = 0, hi = 1) {\n  return Math.max(lo, Math.min(hi, v));\n}\n","import { HistoryInput, PredictionResult } from \"../types\";\nimport { daysBetween, addDaysIso, mean, std, clamp } from \"./utils\";\n\nexport function calendarPredict(history: HistoryInput): PredictionResult {\n  const entries = [...history.periodStarts];\n  if (entries.length < 1) throw new Error(\"need at least one period start\");\n  // ensure chronological earliest -> latest\n  // assuming client sends earliest->latest; if not, caller should sort\n  const intervals: number[] = [];\n  for (let i = 0; i + 1 < entries.length; i++) {\n    intervals.push(daysBetween(entries[i].date, entries[i + 1].date));\n  }\n\n  const last = entries[entries.length - 1].date;\n\n  if (intervals.length === 0) {\n    // cannot compute intervals: fallback to next = last + 28\n    const likely = addDaysIso(last, 28);\n    return {\n      likely,\n      confidence: 0.2,\n      notes: [\"not enough data, used fallback 28d\"],\n    };\n  }\n\n  const avg = Math.round(mean(intervals));\n  const s = std(intervals);\n\n  const likely = addDaysIso(last, avg);\n\n  const windowRadius = Math.min(3, Math.max(1, Math.round(s / 2)));\n  const start = addDaysIso(likely, -windowRadius);\n  const end = addDaysIso(likely, windowRadius);\n\n  // confidence: base on sample size and std\n  const base = clamp((intervals.length - 1) / 10, 0, 0.8); // more samples -> higher\n  const stability = clamp(1 - s / 10, 0, 1);\n  const confidence = clamp(base * 0.6 + stability * 0.4, 0, 1);\n\n  const notes = [\n    `avg interval ${avg}d`,\n    `std ${s.toFixed(2)}d`,\n    `samples ${intervals.length}`,\n  ];\n\n  return { likely, window: { start, end }, confidence, notes };\n}\n","import { HistoryInput, PredictionResult } from \"../types\";\nimport { daysBetween, addDaysIso, mean, std, clamp } from \"./utils\";\n\nfunction computeIntervals(entries: HistoryInput[\"periodStarts\"]): number[] {\n  const intervals: number[] = [];\n  for (let i = 0; i + 1 < entries.length; i++) {\n    intervals.push(daysBetween(entries[i].date, entries[i + 1].date));\n  }\n  return intervals;\n}\n\nexport function wmaPredict(history: HistoryInput): PredictionResult {\n  const entries = [...history.periodStarts];\n  if (entries.length < 1) throw new Error(\"need at least one period start\");\n\n  const intervals = computeIntervals(entries);\n  const last = entries[entries.length - 1].date;\n\n  if (intervals.length === 0) {\n    const likely = addDaysIso(last, 28);\n    return {\n      likely,\n      confidence: 0.2,\n      notes: [\"not enough data, fallback 28d\"],\n    };\n  }\n\n  // weights: more recent intervals get larger weight\n  const n = intervals.length;\n  const rawWeights = intervals.map((_, i) => Math.pow(2, i + 1)); // older -> smaller (we'll normalize reversed)\n  // reverse so last interval gets highest weight\n  rawWeights.reverse();\n  const weightSum = rawWeights.reduce((s, v) => s + v, 0);\n  const wma = intervals.reduce(\n    (s, v, i) => s + v * (rawWeights[i] / weightSum),\n    0\n  );\n  const predictedInterval = Math.round(wma);\n  const likely = addDaysIso(last, predictedInterval);\n\n  const s = std(intervals);\n  const base = clamp((n - 1) / 10, 0, 0.8);\n  const stability = clamp(1 - s / 10, 0, 1);\n  const confidence = clamp(base * 0.5 + stability * 0.5, 0, 1);\n\n  const windowRadius = Math.min(3, Math.max(1, Math.round(s / 2)));\n  const start = addDaysIso(likely, -windowRadius);\n  const end = addDaysIso(likely, windowRadius);\n\n  const notes = [\n    `wma ${wma.toFixed(2)}d`,\n    `pred interval ${predictedInterval}d`,\n    `std ${s.toFixed(2)}d`,\n  ];\n\n  return { likely, window: { start, end }, confidence, notes };\n}\n","import {\n  PredictorConfig,\n  HistoryInput,\n  PredictionResult,\n  FertileWindow,\n  PregnancyPrediction\n} from \"../types\";\n\nimport { DEFAULTS } from \"../constants\";\nimport { calendarPredict } from \"../core/calendarStrategy\";\nimport { wmaPredict } from \"../core/wmaStrategy\";\nimport { addDaysIso } from \"../core/utils\";\n\ntype StrategyFn = (history: HistoryInput, config?: PredictorConfig) => PredictionResult;\n\nexport class PredictionEngine {\n  private config: PredictorConfig;\n  private strategies: Map<string, StrategyFn> = new Map();\n\n  constructor(config?: PredictorConfig) {\n    this.config = { ...DEFAULTS, ...config };\n\n    // default strategies\n    this.registerStrategy(\"calendar\", (h) => calendarPredict(h));\n    this.registerStrategy(\"wma\", (h) => wmaPredict(h));\n  }\n\n  registerStrategy(name: string, fn: StrategyFn) {\n    this.strategies.set(name, fn);\n  }\n\n  private chooseStrategy(name?: string): StrategyFn {\n    const key = name || this.config.strategy || \"wma\";\n    const fn = this.strategies.get(key);\n    if (!fn) throw new Error(`Strategy '${key}' not found`);\n    return fn;\n  }\n\n  // ---------------------------------------------\n  // PERIOD PREDICTION\n  // ---------------------------------------------\n  predictNextPeriod(history: HistoryInput): PredictionResult {\n    const fn = this.chooseStrategy(this.config.strategy);\n    return fn(history, this.config);\n  }\n\n  // ---------------------------------------------\n  // OVULATION\n  // ---------------------------------------------\n  predictOvulation(history: HistoryInput): PredictionResult {\n    const next = this.predictNextPeriod(history);\n    const luteal = this.config.lutealPhaseDays ?? DEFAULTS.lutealPhaseDays;\n\n    const ovulationDate = addDaysIso(next.likely, -luteal);\n\n    const notes = [\n      ...(next.notes || []),\n      `estimated ovulation = ${ovulationDate}`\n    ];\n\n    return {\n      likely: ovulationDate,\n      confidence: next.confidence,\n      notes\n    };\n  }\n\n  // ---------------------------------------------\n  // FERTILE WINDOW\n  // ---------------------------------------------\n  predictFertileWindow(history: HistoryInput): FertileWindow {\n    const ov = this.predictOvulation(history);\n\n    const start = addDaysIso(ov.likely, -5);\n    const end = addDaysIso(ov.likely, 1);\n\n    return {\n      start,\n      peak: ov.likely,\n      end,\n      confidence: ov.confidence,\n      notes: ov.notes\n    };\n  }\n\n  // ---------------------------------------------\n  // PREGNANCY PREDICTION\n  // ---------------------------------------------\n  predictPregnancy(lastPeriodIso: string): PregnancyPrediction {\n    const dueDate = addDaysIso(lastPeriodIso, 280);\n\n    const today = new Date();\n    const ms = today.getTime() - new Date(lastPeriodIso).getTime();\n    const daysSince = Math.round(ms / (1000 * 60 * 60 * 24));\n\n    const currentWeek = Math.max(0, Math.floor(daysSince / 7) + 1);\n    const currentTrimester = Math.min(3, Math.ceil(currentWeek / 13));\n\n    return {\n      dueDate,\n      currentWeek,\n      currentTrimester\n    };\n  }\n\n  // ---------------------------------------------\n  // ANALYZE WITH ALL STRATEGIES\n  // ---------------------------------------------\n  analyze(history: HistoryInput) {\n    const results: Record<string, PredictionResult> = {};\n\n    for (const [name, fn] of this.strategies.entries()) {\n      try {\n        results[name] = fn(history, this.config);\n      } catch {\n        // ignore failing strategies\n      }\n    }\n\n    return results;\n  }\n}\n"],"mappings":"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","names":["DEFAULTS","parseISO","addDays","differenceInCalendarDays","format","parseIsoDay","s","formatIsoDay","d","addDaysIso","iso","days","daysBetween","aIso","bIso","mean","nums","v","std","m","variance","clamp","lo","hi","calendarPredict","history","entries","intervals","i","daysBetween","last","addDaysIso","avg","mean","std","likely","windowRadius","start","end","base","clamp","stability","confidence","notes","computeIntervals","entries","intervals","i","daysBetween","wmaPredict","history","last","addDaysIso","n","rawWeights","_","weightSum","s","v","wma","predictedInterval","likely","std","base","clamp","stability","confidence","windowRadius","start","end","notes","PredictionEngine","config","DEFAULTS","h","calendarPredict","wmaPredict","name","fn","key","history","next","luteal","ovulationDate","addDaysIso","notes","ov","start","end","lastPeriodIso","dueDate","ms","daysSince","currentWeek","currentTrimester","results"]}