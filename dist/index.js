var I={lutealPhaseDays:14,irregularityStdThreshold:4,minIntervalsForConfidence:3};import{parseISO as $,addDays as C,differenceInCalendarDays as T,format as E}from"date-fns";function M(n){return $(n)}function W(n){return E(n,"yyyy-MM-dd")}function i(n,e){return W(C(M(n),e))}function h(n,e){return T(M(e),M(n))}function v(n){return n.length===0?0:n.reduce((e,t)=>e+t,0)/n.length}function m(n){let e=v(n),t=n.reduce((r,o)=>r+(o-e)**2,0)/(n.length||1);return Math.sqrt(t)}function d(n,e=0,t=1){return Math.max(e,Math.min(t,n))}function S(n){let e=[...n.periodStarts];if(e.length<1)throw new Error("need at least one period start");let t=[];for(let c=0;c+1<e.length;c++)t.push(h(e[c].date,e[c+1].date));let r=e[e.length-1].date;if(t.length===0)return{likely:i(r,28),confidence:.2,notes:["not enough data, used fallback 28d"]};let o=Math.round(v(t)),s=m(t),a=i(r,o),l=Math.min(3,Math.max(1,Math.round(s/2))),p=i(a,-l),u=i(a,l),g=d((t.length-1)/10,0,.8),w=d(1-s/10,0,1),P=d(g*.6+w*.4,0,1),x=[`avg interval ${o}d`,`std ${s.toFixed(2)}d`,`samples ${t.length}`];return{likely:a,window:{start:p,end:u},confidence:P,notes:x}}function B(n){let e=[];for(let t=0;t+1<n.length;t++)e.push(h(n[t].date,n[t+1].date));return e}function b(n){let e=[...n.periodStarts];if(e.length<1)throw new Error("need at least one period start");let t=B(e),r=e[e.length-1].date;if(t.length===0)return{likely:i(r,28),confidence:.2,notes:["not enough data, fallback 28d"]};let o=t.length,s=t.map((y,f)=>Math.pow(2,f+1));s.reverse();let a=s.reduce((y,f)=>y+f,0),l=t.reduce((y,f,H)=>y+f*(s[H]/a),0),p=Math.round(l),u=i(r,p),g=m(t),w=d((o-1)/10,0,.8),P=d(1-g/10,0,1),x=d(w*.5+P*.5,0,1),c=Math.min(3,Math.max(1,Math.round(g/2))),k=i(u,-c),F=i(u,c),R=[`wma ${l.toFixed(2)}d`,`pred interval ${p}d`,`std ${g.toFixed(2)}d`];return{likely:u,window:{start:k,end:F},confidence:x,notes:R}}var D=class{config;strategies=new Map;constructor(e){this.config={...I,...e},this.registerStrategy("calendar",t=>S(t)),this.registerStrategy("wma",t=>b(t))}registerStrategy(e,t){this.strategies.set(e,t)}chooseStrategy(e){let t=e||this.config.strategy||"wma",r=this.strategies.get(t);if(!r)throw new Error(`Strategy '${t}' not found`);return r}predictNextPeriod(e){return this.chooseStrategy(this.config.strategy)(e,this.config)}predictOvulation(e){let t=this.predictNextPeriod(e),r=this.config.lutealPhaseDays??I.lutealPhaseDays,o=i(t.likely,-r),s=[...t.notes||[],`estimated ovulation = ${o}`];return{likely:o,confidence:t.confidence,notes:s}}predictFertileWindow(e){let t=this.predictOvulation(e),r=i(t.likely,-5),o=i(t.likely,1);return{start:r,peak:t.likely,end:o,confidence:t.confidence,notes:t.notes}}predictPregnancy(e){let t=i(e,280),o=new Date().getTime()-new Date(e).getTime(),s=Math.round(o/(1e3*60*60*24)),a=Math.max(0,Math.floor(s/7)+1),l=Math.min(3,Math.ceil(a/13));return{dueDate:t,currentWeek:a,currentTrimester:l}}analyze(e){let t={};for(let[r,o]of this.strategies.entries())try{t[r]=o(e,this.config)}catch{}return t}};export{D as PredictionEngine};
//# sourceMappingURL=index.js.map