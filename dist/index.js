var M={lutealPhaseDays:14,irregularityStdThreshold:4,minIntervalsForConfidence:3};import{parseISO as E,addDays as W,differenceInCalendarDays as $,format as B}from"date-fns";function k(r){return E(r)}function N(r){return B(r,"yyyy-MM-dd")}function o(r,e){return N(W(k(r),e))}function b(r,e){return $(k(e),k(r))}function D(r){return r.length===0?0:r.reduce((e,t)=>e+t,0)/r.length}function w(r){let e=D(r),t=r.reduce((n,i)=>n+(i-e)**2,0)/(r.length||1);return Math.sqrt(t)}function c(r,e=0,t=1){return Math.max(e,Math.min(t,r))}function v(r){return r.length<2?{irregular:!1}:w(r)>5?{irregular:!0,message:"Your cycles vary more than usual."}:{irregular:!1}}function C(r){let e=[...r.periodStarts];if(e.length<1)throw new Error("need at least one period start");let t=[];for(let d=0;d+1<e.length;d++)t.push(b(e[d].date,e[d+1].date));let n=e[e.length-1].date;if(t.length===0)return{likely:o(n,28),confidence:.2,notes:["Not enough data for a reliable prediction, using a 28-day cycle as a fallback."]};let i=Math.round(D(t)),s=w(t),a=o(n,i),u=Math.min(3,Math.max(1,Math.round(s/2))),P=o(a,-u),g=o(a,u),y=c((t.length-1)/10,0,.8),x=c(1-s/10,0,1),I=c(y*.6+x*.4,0,1),l=[`Your average cycle length is ${i} days.`,`Based on ${t.length} cycles.`],h=v(t);return h.irregular&&l.push(h.message),s<2?l.push("Your cycles are very regular. Prediction reliability is high."):s<4?l.push("Recent cycles are stable. Prediction reliability is good."):l.push("Cycle variance is slightly higher, which may affect prediction accuracy."),{likely:a,window:{start:P,end:g},confidence:I,notes:l}}function Y(r){let e=[];for(let t=0;t+1<r.length;t++)e.push(b(r[t].date,r[t+1].date));return e}function H(r){let e=[...r.periodStarts];if(e.length<1)throw new Error("need at least one period start");let t=Y(e),n=e[e.length-1].date;if(t.length===0)return{likely:o(n,28),confidence:.2,notes:["Not enough data for a reliable prediction, using a 28-day cycle as a fallback."]};let i=t.length,s=t.map((p,m)=>Math.pow(2,m+1));s.reverse();let a=s.reduce((p,m)=>p+m,0),u=t.reduce((p,m,T)=>p+m*(s[T]/a),0),P=Math.round(u),g=o(n,P),y=w(t),x=c((i-1)/10,0,.8),I=c(1-y/10,0,1),l=c(x*.5+I*.5,0,1),h=Math.min(3,Math.max(1,Math.round(y/2))),d=o(g,-h),F=o(g,h),f=[`Predicted cycle length is ${P} days (based on a weighted average of recent cycles).`],R=v(t);return R.irregular&&f.push(R.message),y<2?f.push("Your cycles are very regular. Prediction reliability is high."):y<4?f.push("Recent cycles are stable. Prediction reliability is good."):f.push("Cycle variance is slightly higher, which may affect prediction accuracy."),{likely:g,window:{start:d,end:F},confidence:l,notes:f}}var S=class{config;strategies=new Map;constructor(e){this.config={...M,...e},this.registerStrategy("calendar",t=>C(t)),this.registerStrategy("wma",t=>H(t))}registerStrategy(e,t){this.strategies.set(e,t)}chooseStrategy(e){let t=e||this.config.strategy||"wma",n=this.strategies.get(t);if(!n)throw new Error(`Strategy '${t}' not found`);return n}predictNextPeriod(e){return this.chooseStrategy(this.config.strategy)(e,this.config)}predictOvulation(e){let t=this.predictNextPeriod(e),n=this.config.lutealPhaseDays??M.lutealPhaseDays,i=o(t.likely,-n),s=[...t.notes||[],`estimated ovulation = ${i}`];return{likely:i,confidence:t.confidence,notes:s}}predictFertileWindow(e){let t=this.predictOvulation(e),n=o(t.likely,-5),i=o(t.likely,1);return{start:n,peak:t.likely,end:i,confidence:t.confidence,notes:t.notes}}predictPregnancy(e){let t=o(e,280),i=new Date().getTime()-new Date(e).getTime(),s=Math.round(i/(1e3*60*60*24)),a=Math.max(0,Math.floor(s/7)+1),u=Math.min(3,Math.ceil(a/13));return{dueDate:t,currentWeek:a,currentTrimester:u}}analyze(e){let t={};for(let[n,i]of this.strategies.entries())try{t[n]=i(e,this.config)}catch{}return t}};export{S as PredictionEngine};
//# sourceMappingURL=index.js.map